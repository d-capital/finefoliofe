<ng-container *ngIf="loading">
  <ng-template [ngTemplateOutlet]="loadingSkeleton"></ng-template>
</ng-container>

<ng-container *ngIf="error">
  <ng-template [ngTemplateOutlet]="errorTemplate"></ng-template>
</ng-container>

<ng-container *ngIf="!loading && !error;">
  <div class="valuate-container">
    <section class="top-card">
      <h1 class="stockname">{{ stockInfo.name }}</h1>
      <h4>{{ ticker }} * {{ exchange }}</h4>
      <h1 *ngIf="stockInfo.exchange !== 'MOEX'">${{ uiRounding(stockInfo.price) }}</h1>
      <h1 *ngIf="stockInfo.exchange === 'MOEX'">₽{{ uiRounding(stockInfo.price) }}</h1>
    </section>

    <app-tabs>
      <app-tab title="{{valuationOverviewLabel}}" name="peter_lynch_valuation">
        <div *ngIf="valuation.avgGrowth === null || stockInfo.epsTtm === null">
          <h2 style="color: grey;">{{ noValuationData }}</h2>
        </div>

        <div *ngIf="valuation.avgGrowth !== null">
          <div *ngIf="valuation.avgGrowth.fiveYears < 0">
            <h2 style="color: grey;">{{ noValuation }}</h2>
          </div>
        </div>

        <div *ngIf="valuation.avgGrowth !== null">
          <div *ngIf="valuation.avgGrowth.fiveYears > 0">
            <!-- Valuation -->
            <section class="top-card">
              <h2>
                <strong>{{ resultLabel }}</strong>
              </h2>
              <h1>
                <div *ngIf="valuation.resultLabel === 'Undervalued'">
                  <app-stock-card [value]="valuation.resultPercent" label="{{upsidePotentialLabel}}" color="green">
                  </app-stock-card>
                </div>
                <div *ngIf="valuation.resultLabel === 'Overvalued'">
                  <app-stock-card [value]="valuation.resultPercent" label="{{downsidePotentialLabel}}" color="red">
                  </app-stock-card>
                </div>
              </h1>
              <h3>
                <span *ngIf="valuation.resultLabel === 'Undervalued'" class="undervalued">
                  {{ undervaluedLabel }}
                </span>
                <span *ngIf="valuation.resultLabel === 'Overvalued'" class="overvalued">
                  {{ overvaluedLabel }}
                </span>
              </h3>
              <p>
                <span *ngIf="valuation.resultLabel === 'Undervalued'">
                  {{ undervaluedExplanation }}
                </span>
                <span *ngIf="valuation.resultLabel === 'Overvalued'">
                  {{ overvaluedExplanation }}
                </span>
              </p>
            </section>

            <section class="card">
              <h2>{{ fairPriceLabel }}</h2>
              <h1 *ngIf="stockInfo.exchange !== 'MOEX'">${{ uiRounding(valuation.fairPrice) }}</h1>
              <h1 *ngIf="stockInfo.exchange === 'MOEX'">₽{{ uiRounding(valuation.fairPrice) }}</h1>
              <p>{{ fairPriceExplanation }}</p>
            </section>

            <section class="card">
              <h2>{{ howFairPriceWasCalulated }}</h2>
              <h1 class="formula">{{ valuation.formula }}</h1>
              <p>{{ formulaLabel }}</p>
              <p class="explanation">{{ formulaExplanationLabel }}</p>
              <p class="explanation">{{ maxGrowthRateNote }}</p>
            </section>

            <!-- Historical profit -->
            <section *ngIf="valuation.netProfitHistory.length > 0" class="card">
              <h2>{{ netProfitGrowthLabel }}</h2>
              <!--p><strong>{{ averageIncomeGrowthLabel }}</strong></p-->
              <ul>
                <li><strong>{{ mathRounding(valuation.avgGrowth.fiveYears) }}%</strong> - {{ averageFiveYearsGrowth }}
                </li>
                <li><strong>{{ mathRounding(valuation.avgGrowth.threeYears) }}%</strong> - {{ averageThreeYearsGrowth }}
                </li>
                <li><strong>{{ mathRounding(valuation.avgGrowth.ttm) }}%</strong> - {{ averageIncomeGrowthTtm }}</li>
              </ul>
              <p>{{ growthRateCalcExplanation }}</p>
              <div class="table-wrapper">
                <table class="financial-table">
                  <thead>
                    <tr>
                      <th>{{ metricLabel }}</th>
                      <th *ngFor="let item of valuation.netProfitHistory">
                        {{ item.year }}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>{{ netProfitLabel }}</td>
                      <td *ngFor="let item of valuation.netProfitHistory">
                        {{ item.value | abbreviateNumber }}
                      </td>
                    </tr>
                    <tr style="background-color: rgb(226, 225, 224);">
                      <td>{{ growthLabel }}</td>
                      <td *ngFor="let item of valuation.netProfitHistory; let i = index">
                        <ng-container *ngIf="i > 0">
                          {{
                          ((valuation.netProfitHistory[i].value - valuation.netProfitHistory[i - 1].value)
                          / valuation.netProfitHistory[i - 1].value * 100) | number:'1.0-0'
                          }}%
                        </ng-container>
                        <ng-container *ngIf="i === 0">—</ng-container>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>

            <section class="card">
              <h2>{{ epsTtmLabel }}</h2>
              <h1 *ngIf="stockInfo.exchange !== 'MOEX'">${{ uiRounding(stockInfo.epsTtm) }}</h1>
              <h1 *ngIf="stockInfo.exchange === 'MOEX'">₽{{ uiRounding(stockInfo.epsTtm) }}</h1>
              <p>{{ epsTtmExplanation }}</p>
            </section>

            <section class="card">
              <h2>{{ pegLabel }}</h2>
              <h1>1</h1>
              <p>{{ pegExplanation }}</p>
            </section>

            <!-- Lynch explanation -->
            <section *ngIf="valuation.avgGrowth.fiveYears > 0" class="card">
              <h2>{{ aboutLynchFormulaLabel }}</h2>
              <p [innerHTML]="aboutLynchFormulaText"></p>
            </section>
          </div>
        </div>
      </app-tab>

      <app-tab title="{{stockInformationLabel}}" name="overview">
        <!-- Public stock data -->
        <section class="top-card">
          <h2>{{ finanacialOverviewLabel }}</h2>
          <div class="data-grid">
            <div class="grid-cell">
              <h3>{{ marketCapLabel }}</h3>
              <p>{{ stockInfo.capitalization | abbreviateNumber }}</p>
            </div>
            <div class="grid-cell">
              <h3>{{ epsTtmLabel }}</h3>
              <p>{{ uiRounding(stockInfo.epsTtm) }}</p>
            </div>
            <div class="grid-cell">
              <h3>{{ peTtmLabel }}</h3>
              <p>{{ uiRounding(stockInfo.peTtm) }}</p>
            </div>
            <!--div class="grid-cell">
                <h3>{{ pegLabel }}</h3>
                <p>{{ uiRounding(valuation.peg) }}</p>
              </div-->
            <div class="grid-cell">
              <h3>{{ dividendsYieldLabel }}</h3>
              <p>{{ uiRounding(stockInfo.dividendYield) }}%</p>
            </div>
            <div class="grid-cell">
              <h3>{{ fcfLabel }}</h3>
              <p>{{ stockInfo.freeCashFlow | abbreviateNumber }}</p>
            </div>
            <div class="grid-cell">
              <h3>{{ deLabel }}</h3>
              <p>{{ uiRounding(stockInfo.debtToEquity) }}</p>
            </div>
          </div>
          <h2>{{ mainStockData }}</h2>
          <div class="info-grid">
            <div>
              <h3>{{ sectorLabel }}</h3>
              <p *ngIf="pageLanguage === 'ru' && stockInfo.exchange === 'MOEX'">{{ stockInfo.sectorRu }}</p>
              <p *ngIf="pageLanguage === 'ru' && stockInfo.exchange !== 'MOEX'">{{ stockInfo.sector }}</p>
              <p *ngIf="pageLanguage === 'en' && stockInfo.exchange !== 'MOEX'">{{ stockInfo.sector }}</p>
              <p *ngIf="pageLanguage === 'en' && stockInfo.exchange === 'MOEX'">{{ stockInfo.sector }}</p>
            </div>
            <div>
              <h3>{{ industryLabel }}</h3>
              <p *ngIf="pageLanguage === 'ru' && stockInfo.exchange === 'MOEX'">{{ stockInfo.industryRu }}</p>
              <p *ngIf="pageLanguage === 'ru' && stockInfo.exchange !== 'MOEX'">{{ stockInfo.industry }}</p>
              <p *ngIf="pageLanguage === 'en' && stockInfo.exchange !== 'MOEX'">{{ stockInfo.industry }}</p>
              <p *ngIf="pageLanguage === 'en' && stockInfo.exchange === 'MOEX'">{{ stockInfo.industry }}</p>
            </div>
          </div>
        </section>
      </app-tab>
      <app-tab title="DCF" name="dcf_valuation">
        <div *ngIf="!dcfValuationLoaded" class="loader"></div>
        <div *ngIf="dcfError">{{noValuationData}}</div>
        <div *ngIf="dcfValuationLoaded && !dcfError">
          <h2>
            <strong>{{ resultLabel }}</strong>
          </h2>
          <h1>
            <div *ngIf="dcfValuationResult === 'Undervalued'">
              <app-stock-card [value]="dcfValuationPercentage" label="{{upsidePotentialLabel}}" color="green">
              </app-stock-card>
            </div>
            <div *ngIf="dcfValuationResult === 'Overvalued'">
              <app-stock-card [value]="dcfValuationPercentage" label="{{downsidePotentialLabel}}" color="red">
              </app-stock-card>
            </div>
          </h1>
          <h3>
            <span *ngIf="dcfValuationResult === 'Undervalued'" class="undervalued">
              {{ undervaluedLabel }}
            </span>
            <span *ngIf="dcfValuationResult === 'Overvalued'" class="overvalued">
              {{ overvaluedLabel }}
            </span>
          </h3>
          <h2>{{ fairPriceLabel }}</h2>
          <div *ngIf="dcfValuation">
            <h1 *ngIf="stockInfo.exchange !== 'MOEX'">${{ uiRounding(dcfValuation) }}</h1>
            <h1 *ngIf="stockInfo.exchange === 'MOEX'">₽{{ uiRounding(dcfValuation) }}</h1>
          </div>
        </div>
        <div *ngIf="pageLanguage == 'en'">
          <h2>DCF Valuation Methodology</h2>
          <p>
            I value companies using a Discounted Cash Flow (DCF) model based on projected Free Cash Flow (FCF)
            discounted by the Weighted Average Cost of Capital (WACC).
          </p>
          <h3>Cost of Capital</h3>
          <p>
            The cost of equity is calculated using the Capital Asset Pricing Model (CAPM):
          </p>
          <p style="text-align:center;">
            <strong>Cost of Equity = Risk-Free Rate + β × (Market Return − Risk-Free Rate)</strong>
          </p>
          <p>
            Beta is estimated via linear regression of the company’s daily log returns against the market index
            over the last three years (S&amp;P 500 for the US market, IMOEX for Russia).
          </p>
          <p>
            The market value of debt is estimated by treating debt as a bond and discounting interest payments
            and principal at the market cost of debt.
          </p>
          <p>
            WACC is calculated using market values of equity and debt, with tax shield applied to debt:
          </p>
          <p style="text-align:center;">
            <strong>
              WACC = E / (E + D) × Re + D / (E + D) × Rd × (1 − Tax)
            </strong>
          </p>
          <h3>Cash Flow Projection and Valuation</h3>
          <p>
            FCF is projected from the latest reported value using a constant growth rate over the forecast period.
            Each projected cash flow is discounted using WACC.
          </p>
          <p>
            Terminal value is calculated using the Gordon Growth Model with a conservative long-term growth rate
            aligned with expected GDP growth.
          </p>
          <p>
            Enterprise value equals the sum of discounted projected FCFs and discounted terminal value.
            Equity value is derived by adjusting for net debt and divided by shares outstanding
            to obtain the fair value per share.
          </p>
        </div>
        <div *ngIf="pageLanguage == 'ru'">
          <h2>Методология оценки DCF</h2>
          <p>
            Оценка компании проводится с использованием метода дисконтированных денежных потоков (DCF),
            основанного на прогнозе свободного денежного потока (FCF) и его дисконтировании
            по средневзвешенной стоимости капитала (WACC).
          </p>
          <h3>Стоимость капитала</h3>
          <p>
            Стоимость собственного капитала рассчитывается по модели CAPM:
          </p>
          <p style="text-align:center;">
            <strong>Стоимость капитала = Безрисковая ставка + β × (Рыночная доходность − Безрисковая ставка)</strong>
          </p>
          <p>
            Коэффициент β оценивается с помощью линейной регрессии дневных логарифмических доходностей акции
            относительно рыночного индекса за последние три года
            (S&amp;P 500 для США, IMOEX для российского рынка).
          </p>
          <p>
            Рыночная стоимость долга оценивается как приведённая стоимость процентных платежей
            и номинала долга, дисконтированных по рыночной стоимости долга.
          </p>
          <p>
            WACC рассчитывается на основе рыночных значений собственного капитала и долга
            с учётом налогового щита:
          </p>
          <p style="text-align:center;">
            <strong>
              WACC = E / (E + D) × Re + D / (E + D) × Rd × (1 − Tax)
            </strong>
          </p>
          <h3>Прогноз денежных потоков и оценка</h3>
          <p>
            Свободный денежный поток прогнозируется от последнего фактического значения
            с использованием постоянного темпа роста.
            Все прогнозные денежные потоки дисконтируются по ставке WACC.
          </p>
          <p>
            Терминальная стоимость рассчитывается по модели постоянного роста
            с консервативным долгосрочным темпом, соответствующим росту экономики.
          </p>
          <p>
            Стоимость компании (Enterprise Value) определяется как сумма дисконтированных FCF
            и терминальной стоимости. Стоимость собственного капитала корректируется на чистый долг
            и делится на количество акций в обращении для получения справедливой цены акции.
          </p>
        </div>
      </app-tab>
    </app-tabs>
  </div>
</ng-container>

<!-- Skeleton Template -->
<ng-template #loadingSkeleton>
  <div class="valuate-container">
    <h1 class="skeleton-box long"></h1>
    <p class="exchange skeleton-box medium"></p>

    <div class="card">
      <h2 class="skeleton-box medium"></h2>
      <div *ngFor="let i of [1,2,3,4,5,6]" class="skeleton-box short"></div>
    </div>

    <div class="card">
      <h2 class="skeleton-box medium"></h2>
      <div *ngFor="let i of [1,2,3]" class="skeleton-box medium"></div>
    </div>

    <div class="card">
      <h2 class="skeleton-box medium"></h2>
      <div *ngFor="let i of [1,2,3,4,5]" class="skeleton-box long"></div>
    </div>
  </div>
</ng-template>

<!-- Error Template -->
<ng-template #errorTemplate>
  <app-error-state [showHomeButton]="true"></app-error-state>
</ng-template>